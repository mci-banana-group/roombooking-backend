# roombooking

This project was created using the [Ktor Project Generator](https://start.ktor.io).

Here are some useful links to get you started:

- [Ktor Documentation](https://ktor.io/docs/home.html)
- [Ktor GitHub page](https://github.com/ktorio/ktor)
- The [Ktor Slack chat](https://app.slack.com/client/T09229ZC6/C0A974TJ9). You'll need
  to [request an invite](https://surveys.jetbrains.com/s3/kotlin-slack-sign-up) to join.

## Authentication

(Authentication Readme generated by AI)
All protected endpoints require a JWT Bearer token.

### 1. Obtain a Token

Send a `POST` request to `/auth/login` with your credentials:

```json
{
  "email": "admin@mci.edu",
  "password": "password"
}
```

You will receive a response containing the token:

```json
{
  "token": "your_jwt_token_here",
  "user": {
    "firstName": "Admin",
    "...": "..."
  }
}
```

### 2. Use the Token

Include the token in the `Authorization` header of your requests to protected endpoints:

```http
Authorization: Bearer your_jwt_token_here
```

### Example (JavaScript/Fetch)

```javascript
const token = "your_jwt_token_here";

fetch('https://roombooking-backend-l7kv.onrender.com/rooms', {
    method: 'GET',
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    }
})
.then(response => response.json())
.then(data => console.log(data));
```

## API Documentation

The API documentation is available via Swagger UI when the server is running:

- [http://localhost:8080/swagger](http://localhost:8080/swagger)

## Features

Here's a list of features included in this project:

| Name                                               | Description                                                 |
|----------------------------------------------------|-------------------------------------------------------------|
| [Routing](https://start.ktor.io/p/routing-default) | Allows to define structured routes and associated handlers. |

## Building & Running

To build or run the project, use one of the following tasks:

| Task                                    | Description                                                          |
|-----------------------------------------|----------------------------------------------------------------------|
| `./gradlew test`                        | Run the tests                                                        |
| `./gradlew build`                       | Build everything                                                     |
| `./gradlew buildFatJar`                 | Build an executable JAR of the server with all dependencies included |
| `./gradlew buildImage`                  | Build the docker image to use with the fat JAR                       |
| `./gradlew publishImageToLocalRegistry` | Publish the docker image locally                                     |
| `./gradlew run`                         | Run the server                                                       |
| `./gradlew runDocker`                   | Run app + postgres using docker compose                              |


If the server starts successfully, you'll see the following output:

```
2024-12-04 14:32:45.584 [main] INFO  Application - Application started in 0.303 seconds.
2024-12-04 14:32:45.682 [main] INFO  Application - Responding at http://0.0.0.0:8080
```

## PostgreSQL Database
As for now, when used with the PostgreSQL, the application will run with the following command:
```bash
docker compose up --build
```

The PostgreSQL data is persisted in the `postgres_data` volume (local on your docker), so it survives restarts.

Tables, columns, and data are created (as for now) by the application when it starts for the first time.

If you made changes and want to reset the database, you can delete the `postgres_data` volume and restart the application with the following commands:
```bash
docker compose down
docker compose up -d
```

You can connect and manage the database using pgAdmin or the following command:
```bash
psql "host=127.0.0.1 port=5433 dbname=roombooking user=admin"
```
Or connecting through pgAdmin. Make sure to use the correct port number as it stands in the docker-compose.yml file (5433 for now).

Use the following credentials to connect:
- **Username**: `admin`
- **Password**: `banana`

## MQTT Integration & Room Displays

This service integrates with an MQTT broker to publish dynamic check-in codes for room displays.

### Prerequisites

An MQTT broker (e.g., Eclipse Mosquitto) must be running. By default, the application connects to:
- **URL**: `tcp://localhost:1883`
- **Client ID**: `RoomBookingBackend`

### Topic Structure

The backend publishes the current valid confirmation code to the following topic:

`room/{roomId}/code`

- **Payload**: The 4-digit confirmation code (string).
- **QoS**: 1
- **Retained**: true (New subscribers/screens get the latest code immediately).

### Workflow

1.  **Booking Creation**: When a booking is created, a unique 4-digit confirmation code is generated.
2.  **Check-in Window**: A background scheduler runs periodically to check for bookings starting within the grace period (15 minutes).
3.  **Publishing**: If a booking is entering the check-in window, the code is published to the specific room's topic.
4.  **Display**: IoT screens subscribing to `room/{roomId}/code` will receive and display this code.
5.  **Check-in**: Users enter this code in the app to verify their presence.

### Running Locally with Mosquitto

1.  **Imstall & Start Mosquitto**:
    - Windows: `mosquitto -v`
    - Linux/Mac: `brew install mosquitto && mosquitto`
2.  **Subscribe to debug**:
    ```bash
    mosquitto_sub -t "room/+/code" -v
    ```
3.  **Run the Backend**:
    ```bash
    ./gradlew run
    ```
